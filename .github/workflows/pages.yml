name: Build & Deploy (debug-first)

on:
  workflow_dispatch: {}   # run manually while iterating
  push:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug env
        run: |
          set -eux
          pwd
          ls -la
          echo "PATH=$PATH"
          env | sort | sed -n '1,200p'

      - name: Install system dependencies
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y \
            perl \
            cpanminus \
            poppler-utils \
            texlive-luatex \
            texlive-latex-base \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-extra-utils \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-science \
            latexmk \
            ffmpeg \
            inkscape \
            curl \
            make
          command -v latexmk
          command -v lualatex
          command -v bibtex
          command -v perl

      - name: Convert SVGs (Inkscape)
        run: |
          bash scripts/export_to_latex.sh

      - name: Install beamer-reveal Perl script (local::lib)
        shell: bash
        run: |
          set -eux
          cpanm --notest --local-lib="$HOME/perl5" local::lib
          eval "$(perl -I "$HOME/perl5/lib/perl5" -Mlocal::lib)"

          cpanm --notest WDAEMS/BeamerReveal-20260130.1210.tar.gz

          # Persist the effective env to later steps
          echo "$HOME/perl5/bin" >> "$GITHUB_PATH"
          {
            echo "PERL5LIB=$PERL5LIB"
            echo "PERL_LOCAL_LIB_ROOT=$PERL_LOCAL_LIB_ROOT"
            echo "PERL_MB_OPT=$PERL_MB_OPT"
            echo "PERL_MM_OPT=$PERL_MM_OPT"
          } >> "$GITHUB_ENV"

          command -v beamer-reveal.pl

      - name: Install beamer-reveal LaTeX package from CTAN
        run: |
          set -eux
          mkdir -p /tmp/beamer-reveal
          cd /tmp/beamer-reveal

          wget https://mirrors.ctan.org/macros/latex/contrib/beamer-contrib/beamer-reveal.zip
          unzip beamer-reveal.zip
          cd beamer-reveal
          latex beamer-reveal.ins
          cd ..

          # Install into TEXMFLOCAL
          sudo mkdir -p /usr/local/share/texmf/tex/latex/
          sudo mv beamer-reveal /usr/local/share/texmf/tex/latex/

          # Refresh TeX file database
          sudo texhash
          kpsewhich beamer-reveal.sty

      - name: Build
        env:
          TERM: xterm-256color
          COLUMNS: "120"
          LINES: "40"
        run: |
          set -euxo pipefail
          chmod +x ci/build.sh
          ./ci/build.sh

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: website

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy
        id: deployment
        uses: actions/deploy-pages@v4

